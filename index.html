<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SAMY&AHMED HR | النظام الإداري</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gold: { 500:'#1F2937', 600:'#000000', accent:'#C5A059' },
                    },
                    fontFamily: { sans: ['Tajawal', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F3F4F6; color: #111827; -webkit-tap-highlight-color: transparent; }
        * { transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: white; z-index: 50; transition: transform 0.25s ease-out; box-shadow: 4px 0 15px rgba(0,0,0,0.05); }
        .sidebar-closed { transform: translateX(100%); }
        body.menu-open { overflow: hidden; height: 100vh; position: fixed; width: 100%; }
        
        /* Active Tab Styling */
        .sidebar-nav-item.active { 
            background-color: #000; 
            color: white; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }
        .sidebar-nav-item.active .tab-icon { 
            background-color: white; 
            color: #000; 
        }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.2s; backdrop-filter: blur(4px); }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-card { background: white; width: 90%; max-width: 400px; border-radius: 24px; padding: 30px; transform: scale(0.95); transition: transform 0.2s; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .modal-overlay.active .modal-card { transform: scale(1); }

        /* Inputs */
        .std-input { width: 100%; padding: 14px; border: 1px solid #E5E7EB; border-radius: 14px; outline: none; text-align: center; font-weight: bold; background: #F9FAFB; font-size: 0.95rem; }
        .std-input:focus { border-color: #000; background: #fff; box-shadow: 0 0 0 3px rgba(0,0,0,0.05); }
        .attendance-input { font-size: 3.5rem; font-weight: 800; text-align: center; width: 100%; outline: none; background: transparent; letter-spacing: 4px; height: 80px; }

        /* SweetAlert */
        div:where(.swal2-container) div:where(.swal2-popup) { background: #000 !important; border: 1px solid #333 !important; border-radius: 24px !important; padding: 2rem !important; }
        div:where(.swal2-container) .swal2-title { color: #fff !important; font-family: 'Tajawal'; }
        div:where(.swal2-container) .swal2-html-container { color: #aaa !important; }
        .swal2-icon { animation: none !important; border-color: #C5A059 !important; color: #C5A059 !important; }
        .action-btn-gray { background-color: #1F2937; color: white; border: 1px solid #374151; transition: 0.2s; }
        .action-btn-gray:active { transform: scale(0.97); background: #000; }
        .swal-lux-input { background: #1F2937; border: 1px solid #374151; color: white; text-align: center; padding: 12px; border-radius: 12px; width: 85%; margin: 8px auto; display: block; outline: none; font-family: 'Tajawal'; }

        /* Main Layout - FULL WIDTH FIX */
        .main-content {
            min-height: 100vh;
            padding: 1.5rem;
            padding-top: 5rem; /* Added padding top for fixed header on mobile */
            transition: margin-right 0.25s ease-out;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .page-container {
            width: 100%;
            max-width: 1400px; /* Increased max-width */
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-grow: 1;
        }

        @media (min-width: 1024px) {
            .main-content { margin-right: 260px; width: calc(100% - 260px); padding-top: 1.5rem; /* Reset padding on desktop */ }
        }
        
        .table-responsive { width: 100%; overflow-x: auto; border-radius: 1rem; border: 1px solid #E5E7EB; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { text-align: right; padding: 1rem; white-space: nowrap; }
    </style>
</head>
<body class="min-h-screen bg-gray-50 overflow-x-hidden selection:bg-black selection:text-white">

    <header class="lg:hidden bg-white/95 backdrop-blur shadow-sm px-5 py-3 flex items-center justify-between fixed top-0 w-full z-40 h-16 border-b border-gray-100">
        <h1 class="font-extrabold text-gray-900 text-xl flex items-center gap-2 tracking-tight">SAMY & AHMED</h1>
        <button id="headerBtn" onclick="handleHeaderBtn()" class="bg-black text-white px-5 py-2 rounded-xl text-xs font-bold shadow hover:bg-gray-800 transition">تسجيل دخول</button>
    </header>

    <div id="sidebarOverlay" onclick="closeSidebar()" class="fixed inset-0 bg-black/60 z-40 hidden lg:hidden backdrop-blur-sm"></div>
    <aside id="sidebar" class="sidebar fixed top-0 right-0 h-full sidebar-closed lg:translate-x-0 lg:static flex flex-col">
        <div class="p-10 text-center border-b border-gray-50">
            <div class="w-16 h-16 bg-black text-white rounded-full flex items-center justify-center mx-auto mb-3 text-2xl shadow-xl"><i class="fas fa-cut"></i></div>
            <h2 class="font-extrabold text-xl tracking-wide">SAMY & AHMED</h2>
            <p class="text-[10px] text-gray-400 mt-1 font-bold tracking-[0.2em] uppercase">Salon System</p>
        </div>
        <nav class="p-4 space-y-2 flex-grow overflow-y-auto" id="sidebarNav">
            <div onclick="switchTab('dashboard')" class="sidebar-nav-item p-3.5 rounded-xl hover:bg-gray-50 cursor-pointer flex items-center gap-4 font-bold text-gray-700 text-sm transition group active"><span class="tab-icon w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center group-hover:bg-white group-hover:text-black transition"><i class="fas fa-clock"></i></span> الرئيسية</div>
            <div onclick="authAdmin('finance')" class="sidebar-nav-item p-3.5 rounded-xl hover:bg-gray-50 cursor-pointer flex items-center gap-4 font-bold text-gray-700 text-sm transition group"><span class="tab-icon w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center group-hover:bg-white group-hover:text-black transition"><i class="fas fa-wallet"></i></span> الماليات</div>
            <div onclick="authAdmin('movements')" class="sidebar-nav-item p-3.5 rounded-xl hover:bg-gray-50 cursor-pointer flex items-center gap-4 font-bold text-gray-700 text-sm transition group"><span class="tab-icon w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center group-hover:bg-white group-hover:text-black transition"><i class="fas fa-history"></i></span> سجل التحركات</div>
            <div onclick="authAdmin('reports')" class="sidebar-nav-item p-3.5 rounded-xl hover:bg-gray-50 cursor-pointer flex items-center gap-4 font-bold text-gray-700 text-sm transition group"><span class="tab-icon w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center group-hover:bg-white group-hover:text-black transition"><i class="fas fa-file-invoice"></i></span> الرواتب</div>
            <div onclick="authAdmin('employees')" class="sidebar-nav-item p-3.5 rounded-xl hover:bg-gray-50 cursor-pointer flex items-center gap-4 font-bold text-gray-700 text-sm transition group"><span class="tab-icon w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center group-hover:bg-white group-hover:text-black transition"><i class="fas fa-users"></i></span> الموظفين</div>
            <div onclick="authAdmin('settings')" class="sidebar-nav-item p-3.5 rounded-xl hover:bg-gray-50 cursor-pointer flex items-center gap-4 font-bold text-gray-700 text-sm transition group"><span class="tab-icon w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center group-hover:bg-white group-hover:text-black transition"><i class="fas fa-cog"></i></span> الإعدادات</div>
        </nav>
        <div class="p-5 border-t border-gray-50 text-center">
            <button onclick="logout()" class="text-red-500 font-bold text-sm w-full py-3 hover:bg-red-50 rounded-xl transition flex items-center justify-center gap-2"><i class="fas fa-sign-out-alt"></i> تسجيل خروج</button>
        </div>
    </aside>

    <div id="loginModal" class="modal-overlay">
        <div class="modal-card text-center">
            <div class="w-16 h-16 bg-black text-white rounded-full mx-auto mb-5 flex items-center justify-center text-3xl shadow-xl"><i class="fas fa-user-lock"></i></div>
            <h3 class="font-bold text-xl mb-6 text-gray-900">دخول الإدارة</h3>
            <input type="text" id="loginUser" class="std-input" placeholder="اسم المستخدم">
            <input type="password" id="loginPass" class="std-input mt-3" placeholder="كلمة المرور">
            <button onclick="performLogin()" class="w-full bg-black text-white py-4 rounded-xl font-bold mt-4 hover:bg-gray-900 shadow-lg transition transform active:scale-95">دخول</button>
            <button onclick="toggleLogin()" class="mt-4 text-xs text-gray-400 font-bold hover:text-gray-600">إلغاء</button>
        </div>
    </div>

    <div id="empModal" class="modal-overlay">
        <div class="modal-card">
            <h3 class="font-bold text-xl mb-6 text-center border-b pb-4">بيانات الموظف</h3>
            <input id="empName" class="std-input" placeholder="الاسم ثلاثي">
            <select id="empJob" class="std-input bg-white cursor-pointer mt-3"><option value="مصفف شعر">مصفف شعر</option><option value="مساعد">مساعد</option><option value="كاشير">كاشير</option><option value="مدير">مدير</option></select>
            <div class="flex gap-3 mt-3"><input id="empCode" type="number" class="std-input" placeholder="الكود"><input id="empSalary" type="number" class="std-input" placeholder="الراتب"></div>
            <div class="flex gap-3 mt-3"><input id="empComm" type="number" class="std-input" placeholder="النسبة %"><input id="empVac" type="number" class="std-input" placeholder="رصيد الإجازات"></div>
            <button onclick="saveEmployee()" class="w-full bg-black text-white py-3 rounded-xl font-bold mt-4 shadow-lg active:scale-95 transition">حفظ البيانات</button>
            <button onclick="document.getElementById('empModal').classList.remove('active')" class="w-full mt-3 text-xs text-gray-500 font-bold">إلغاء</button>
        </div>
    </div>

    <div class="main-content flex flex-col items-center">
        
        <section id="dashboard" class="tab-content page-container w-full h-full flex flex-col items-center justify-center pt-10 flex-grow">
            <!-- Increased max-w-2xl to max-w-3xl for wider layout on desktop/tablet -->
            <div id="adminMsgBar" class="w-full max-w-3xl mb-12 hidden bg-gray-900 text-white p-6 rounded-2xl border-r-4 border-yellow-500 flex items-center gap-4 shadow-xl transform transition">
                <div class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center flex-shrink-0"><i class="fas fa-bullhorn text-yellow-400 text-xl"></i></div>
                <p id="adminMsgText" class="text-lg font-bold leading-relaxed">...</p>
            </div>

            <div class="text-center mb-12">
                <div class="text-gray-400 text-xl font-bold mb-3 tracking-widest" id="liveDate">...</div>
                <div class="inline-flex items-baseline gap-3 text-black" style="font-family: monospace;">
                    <span class="text-8xl font-bold tracking-tighter" id="liveClock">00:00:00</span>
                    <span class="text-3xl font-bold text-gray-300" id="liveAmPm">--</span>
                </div>
            </div>

            <!-- Increased max-w-2xl to max-w-3xl -->
            <div class="bg-white p-12 rounded-[3rem] shadow-xl shadow-gray-200/50 border border-gray-100 w-full max-w-3xl text-center mb-12">
                <label class="block text-gray-400 text-sm font-bold mb-6 uppercase tracking-widest">أدخل الكود الوظيفي</label>
                <input type="number" id="codeInput" class="attendance-input" placeholder="" autocomplete="off" autofocus>
                <button onclick="handleAttendance()" class="w-full bg-black text-white py-5 rounded-2xl font-bold mt-10 shadow-xl active:scale-95 transition flex items-center justify-center gap-3 text-xl"><span>تسجيل الحضور</span> <i class="fas fa-fingerprint text-2xl"></i></button>
            </div>

            <!-- Increased max-w-2xl to max-w-3xl -->
            <div class="flex gap-6 w-full max-w-3xl">
                <div class="flex-1 bg-white p-6 rounded-3xl shadow-sm border-b-8 border-green-500 text-center"><div class="text-6xl font-bold text-gray-900" id="presentCount">٠</div><div class="text-sm text-green-600 font-bold mt-2">حضور حالي</div></div>
                <div class="flex-1 bg-white p-6 rounded-3xl shadow-sm border-b-8 border-yellow-500 text-center"><div class="text-6xl font-bold text-gray-900" id="breakCount">٠</div><div class="text-sm text-yellow-600 font-bold mt-2">في استراحة</div></div>
            </div>
        </section>

        <section id="finance" class="tab-content hidden page-container w-full pt-6">
            <div class="bg-white p-8 rounded-3xl shadow-sm mb-6 w-full">
                <h2 class="text-2xl font-bold mb-8 border-b border-gray-100 pb-4 text-gray-800 flex items-center gap-2">
                    <i class="fas fa-wallet text-gold-500"></i> إدارة الماليات
                </h2>
                <div class="bg-gray-50 p-6 rounded-2xl border border-gray-100 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div class="md:col-span-1">
                            <label class="text-xs font-bold text-gray-400 mb-2 block">الموظف</label>
                            <select id="finEmpSelect" onchange="showEmpFinance()" class="std-input bg-white cursor-pointer h-12 mb-0"><option value="">اختر موظف</option></select>
                        </div>
                        <div class="md:col-span-1">
                            <label class="text-xs font-bold text-gray-400 mb-2 block">نوع العملية</label>
                            <select id="finType" onchange="toggleAmount()" class="std-input bg-white cursor-pointer h-12 mb-0">
                                <option value="revenue">تسجيل إيراد</option>
                                <option value="vacation">إجازة (رصيد)</option>
                                <option value="loan">سلفة نقدية</option>
                                <option value="ded_money">خصم مبلغ</option>
                                <option value="ded_q">خصم ربع يوم</option>
                                <option value="ded_h">خصم نص يوم</option>
                                <option value="ded_f">غياب يوم كامل</option>
                            </select>
                        </div>
                        <div class="md:col-span-1">
                            <label class="text-xs font-bold text-gray-400 mb-2 block">القيمة</label>
                            <input id="finAmount" type="number" class="std-input h-12 mb-0" placeholder="المبلغ (ج.م)">
                        </div>
                        <div class="md:col-span-1">
                            <button onclick="addTransaction()" class="w-full bg-black text-white h-12 rounded-xl font-bold shadow-lg hover:bg-gray-900 transition flex items-center justify-center gap-2">
                                <i class="fas fa-save"></i> حفظ العملية
                            </button>
                        </div>
                    </div>
                </div>
                <div class="border border-gray-100 rounded-2xl overflow-hidden">
                    <div class="bg-gray-900 text-white p-4 flex justify-between items-center">
                        <div class="font-bold text-lg flex items-center gap-2"><i class="fas fa-user-circle"></i> <span id="finName">اختر موظف</span></div>
                        <div class="text-sm font-medium opacity-90">
                            اليومية: <span id="finDailyRate" class="font-bold text-yellow-400 text-lg mx-1">0.00</span> |
                            الصافي (سلف/خصم): <span id="finTotal" class="font-bold text-yellow-400 text-lg mx-1">0.00</span> | 
                            إجازات: <span id="finVacBal" class="font-bold">0</span>
                        </div>
                    </div>
                    <div class="overflow-y-auto max-h-96 bg-white">
                        <table class="w-full text-right text-sm">
                            <thead class="bg-gray-50 text-gray-500 sticky top-0">
                                <tr><th class="p-4">التاريخ</th><th class="p-4">النوع</th><th class="p-4">القيمة</th><th class="p-4 text-center">حذف</th></tr>
                            </thead>
                            <tbody id="finTable" class="divide-y divide-gray-50">
                                <tr><td colspan="4" class="p-8 text-center text-gray-400">لا توجد بيانات</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="movements" class="tab-content hidden page-container w-full pt-6">
            <div class="bg-white p-8 rounded-3xl shadow-sm min-h-[600px] w-full">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <h2 class="font-bold text-2xl text-gray-800 w-full md:w-auto text-right">سجل التحركات</h2>
                    <button onclick="exportMovementsExcel()" class="bg-green-600 text-white px-8 py-2 rounded-xl text-sm font-bold shadow-md hover:bg-green-700 transition flex items-center justify-center gap-2 transform hover:scale-105 md:mx-auto">
                        <i class="fas fa-file-excel text-lg"></i> <span>تصدير Excel</span>
                    </button>
                    <div class="flex gap-2 w-full md:w-auto justify-center">
                        <input type="month" id="moveMonth" class="bg-gray-50 border rounded-xl px-3 py-2 text-sm font-bold outline-none focus:border-black transition">
                        <button onclick="calcMovements()" class="bg-black text-white px-6 py-2 rounded-xl text-xs font-bold shadow-md hover:bg-gray-800">عرض</button>
                    </div>
                </div>
                <div class="table-responsive rounded-xl border border-gray-100">
                    <table class="w-full text-right bg-white text-sm whitespace-nowrap min-w-full" id="moveTable">
                        <thead class="bg-gray-50 text-xs font-bold text-gray-500 uppercase">
                            <tr>
                                <th class="p-4">التاريخ</th><th class="p-4">الموظف</th><th class="p-4">حضور/انصراف</th>
                                <th class="p-4 text-yellow-600">بريك</th><th class="p-4 text-green-600">صلاة</th><th class="p-4 text-blue-600">إذن</th><th class="p-4 text-gray-500">فرع آخر</th>
                            </tr>
                        </thead>
                        <tbody id="moveTableBody" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="reports" class="tab-content hidden page-container w-full pt-6">
            <div class="bg-white p-8 rounded-3xl shadow-sm min-h-[600px] w-full">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <h2 class="font-bold text-2xl text-gray-800 w-full md:w-auto text-right">تقرير الرواتب</h2>
                    <button onclick="exportExcel()" class="bg-green-600 text-white px-8 py-2 rounded-xl text-sm font-bold shadow-md hover:bg-green-700 transition flex items-center justify-center gap-2 transform hover:scale-105 md:mx-auto">
                        <i class="fas fa-file-excel text-lg"></i> <span>تصدير Excel</span>
                    </button>
                    <div class="flex gap-2 w-full md:w-auto justify-center">
                        <input type="month" id="reportMonth" class="bg-gray-50 border rounded-xl px-3 py-2 text-sm font-bold outline-none focus:border-black transition">
                        <button onclick="calcReports()" class="bg-black text-white px-6 py-2 rounded-xl text-xs font-bold shadow-md hover:bg-gray-800">عرض</button>
                    </div>
                </div>
                <div class="table-responsive rounded-2xl border border-gray-100">
                    <table class="w-full text-right bg-white text-base min-w-[900px]" id="salaryTable">
                        <thead class="bg-gray-900 text-white text-sm font-bold">
                            <tr>
                                <th class="p-4 whitespace-nowrap">الموظف</th><th class="p-4 whitespace-nowrap">الأساسي</th>
                                <th class="p-4 whitespace-nowrap text-green-400">إضافي وعمولات</th>
                                <th class="p-4 whitespace-nowrap text-red-300">تأخيرات</th>
                                <th class="p-4 whitespace-nowrap text-red-300">خصومات/سلف</th>
                                <th class="p-4 whitespace-nowrap bg-gray-800">الصافي</th>
                            </tr>
                        </thead>
                        <tbody id="reportBody" class="divide-y divide-gray-100 font-medium text-gray-700"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="employees" class="tab-content hidden page-container w-full max-w-5xl pt-6">
            <div class="bg-white p-8 rounded-3xl shadow-sm min-h-[600px] w-full">
                <div class="flex justify-between items-center mb-8"><h2 class="font-bold text-2xl text-gray-800">قائمة الموظفين</h2><button onclick="openEmpModal()" class="bg-black text-white px-6 py-3 rounded-xl font-bold text-xs shadow-lg hover:bg-gray-800 transition flex items-center gap-2"><i class="fas fa-plus"></i> موظف جديد</button></div>
                <div class="table-responsive rounded-2xl border border-gray-100"><table class="w-full text-right text-sm min-w-full"><thead class="bg-gray-50 text-gray-500 uppercase text-xs"><tr><th class="p-4">ID</th><th class="p-4">الاسم</th><th class="p-4">الوظيفة</th><th class="p-4">الراتب</th><th class="p-4">رصيد</th><th class="p-4">نسبة</th><th class="p-4 text-center">تحكم</th></tr></thead><tbody id="empTable" class="divide-y divide-gray-50"></tbody></table></div>
            </div>
        </section>

        <section id="settings" class="tab-content hidden page-container w-full max-w-xl pt-6">
            <div class="bg-white p-8 rounded-3xl shadow-sm mb-4">
                <h3 class="font-bold border-b border-gray-100 pb-4 mb-4 text-lg">رسالة للموظفين</h3>
                <textarea id="adminMsgIn" class="w-full p-4 border border-gray-200 rounded-xl text-sm outline-none focus:border-black transition bg-gray-50" rows="3" placeholder="اكتب التنبيه هنا..."></textarea>
                <div class="flex gap-3 mt-4 items-center">
                    <div class="bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 flex items-center gap-2"><input type="number" id="msgDur" class="w-10 bg-transparent text-center font-bold outline-none" value="60"><span class="text-xs text-gray-500 font-bold">دقيقة</span></div>
                    <button onclick="saveMsg()" class="bg-black text-white px-6 py-2 rounded-xl font-bold text-sm flex-grow shadow-md hover:bg-gray-900 transition">نشر الرسالة</button>
                </div>
            </div>
            <div class="bg-white p-8 rounded-3xl shadow-sm mb-4">
                <h3 class="font-bold border-b border-gray-100 pb-4 mb-4 text-lg">الأمان والنظام</h3>
                <div class="space-y-4">
                    <button onclick="changePassModal()" class="w-full bg-gray-900 text-white py-4 rounded-xl text-sm font-bold hover:bg-black transition shadow-md flex justify-between px-6"><span>تغيير كلمة المرور</span> <i class="fas fa-lock"></i></button>
                    <div><label class="text-xs font-bold text-gray-400">بداية الوردية (نظام 24 ساعة)</label><div class="flex gap-2"><input type="number" id="shiftStartInput" class="std-input mt-1" placeholder="مثال: 13"><button onclick="saveShift()" class="w-1/3 bg-gray-800 text-white rounded-xl text-sm font-bold mt-1">حفظ</button></div></div>
                </div>
            </div>
            <div class="bg-white p-8 rounded-3xl shadow-sm mb-4">
                <h3 class="font-bold border-b border-gray-100 pb-4 mb-4 text-lg">إدارة البيانات</h3>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="backupData()" class="p-4 bg-blue-50 text-blue-600 rounded-xl font-bold text-sm hover:bg-blue-100 transition shadow-sm border border-blue-100 flex flex-col items-center gap-2"><i class="fas fa-download text-xl"></i> تحميل نسخة</button>
                     <label class="p-4 bg-green-50 text-green-600 rounded-xl font-bold text-sm hover:bg-green-100 transition shadow-sm border border-green-100 flex flex-col items-center gap-2 cursor-pointer">
                        <input type="file" onchange="restoreData(this)" class="hidden"><i class="fas fa-upload text-xl"></i> استعادة
                    </label>
                </div>
                <div class="text-center pt-6">
                    <button onclick="resetSys()" class="text-red-500 font-bold text-xs hover:text-red-700 hover:bg-red-50 px-6 py-3 rounded-xl transition border border-red-100">⚠ حذف جميع البيانات (Factory Reset)</button>
                </div>
            </div>
        </section>

        <footer class="w-full text-center py-6 text-[10px] text-gray-400 font-bold tracking-[0.2em] uppercase mt-auto">
            Developed By Mustafa Zuhair
        </footer>

    </div>

    <script>
        let adminPIN=localStorage.getItem('sa_pin')||'241120', employees=JSON.parse(localStorage.getItem('sa_emps'))||[], logs=JSON.parse(localStorage.getItem('sa_logs'))||[], finance=JSON.parse(localStorage.getItem('sa_fin'))||[], isLoggedIn=sessionStorage.getItem('sa_session')==='true', editId=null;
        let shiftStart = parseInt(localStorage.getItem('sa_shift')) || 13; 
        const RULES = { breakLimit: 30, prayLimit: 15, late15: 0.25, late60: 0.50, late120: 1.00 };
        const toArabic = n => (n+'').replace(/\d/g, d => "٠١٢٣٤٥٦٧٨٩"[d]);
        let activeTab = 'dashboard';

        function startClock() {
            const update = () => {
                const d=new Date(); let h=d.getHours(), m=d.getMinutes(), s=d.getSeconds(); const ampm=h>=12?'م':'ص'; h=h%12;h=h?h:12;
                document.getElementById('liveClock').innerText=`${toArabic(h)}:${toArabic(m.toString().padStart(2,'0'))}:${toArabic(s.toString().padStart(2,'0'))}`;
                document.getElementById('liveAmPm').innerText=ampm;
                document.getElementById('liveDate').innerText=`${toArabic(d.getDate())}/${toArabic(d.getMonth()+1)}/${toArabic(d.getFullYear())}`;
            };
            update(); setInterval(update, 1000);
        }

        window.onload=()=>{
            startClock();
            const d = new Date().toISOString().slice(0,7);
            document.getElementById('reportMonth').value=d; document.getElementById('moveMonth').value=d;
            
            // Check admin message expiration
            const m=localStorage.getItem('sa_msg'), e=localStorage.getItem('sa_msg_exp');
            if(m && e && Date.now() < parseInt(e)){
                document.getElementById('adminMsgBar').classList.remove('hidden');
                document.getElementById('adminMsgText').innerText=m;
                document.getElementById('adminMsgIn').value=m;
            } else {
                // If expired or missing, ensure storage is clean and the bar is hidden
                localStorage.removeItem('sa_msg');
                localStorage.removeItem('sa_msg_exp');
                document.getElementById('adminMsgBar').classList.add('hidden');
            }
            
            if(isLoggedIn) document.getElementById('headerBtn').innerText='القائمة';
            
            document.getElementById('shiftStartInput').value = shiftStart;
            document.getElementById('codeInput').addEventListener('keypress',e=>{if(e.key==='Enter')handleAttendance()});
            document.getElementById('loginPass').addEventListener('keypress',e=>{if(e.key==='Enter')performLogin()});
            
            // Initialize tab display and highlight
            switchTab(activeTab); 
            updateStats();
        };

        function showSwal(title, icon='success') {
            Swal.fire({
                title: title, icon: icon, confirmButtonText: 'حسناً', confirmButtonColor: '#C5A059', background: '#000000', color: '#fff',
                iconColor: icon==='success'?'#10B981':'#EF4444',
                timer: 1500, showConfirmButton: false
            });
        }

        function handleHeaderBtn(){if(isLoggedIn)toggleSidebar();else toggleLogin();}
        function toggleLogin(){const m=document.getElementById('loginModal');m.classList.toggle('active');if(m.classList.contains('active'))document.getElementById('loginUser').focus();}
        function performLogin(){
            const u=document.getElementById('loginUser').value,p=document.getElementById('loginPass').value;
            if(u==='admin'&&p===adminPIN){
                isLoggedIn=true; sessionStorage.setItem('sa_session','true'); document.getElementById('headerBtn').innerText='القائمة';
                toggleLogin(); showSwal('مرحباً بك', 'success'); document.getElementById('loginUser').value='';document.getElementById('loginPass').value='';
                // After successful login, set active tab to a privileged one or refresh view
                switchTab('dashboard');
            } else { showSwal('بيانات خاطئة', 'error'); }
        }
        function logout(){isLoggedIn=false;sessionStorage.removeItem('sa_session');document.getElementById('headerBtn').innerText='تسجيل دخول';closeSidebar();switchTab('dashboard');showSwal('تم الخروج');}
        function toggleSidebar(){const s=document.getElementById('sidebar'),o=document.getElementById('sidebarOverlay');s.classList.toggle('sidebar-closed');o.classList.toggle('hidden');if(document.body.classList.contains('menu-open')){document.body.classList.remove('menu-open')}else{document.body.classList.add('menu-open');}}
        function closeSidebar(){document.getElementById('sidebar').classList.add('sidebar-closed');document.getElementById('sidebarOverlay').classList.add('hidden');document.body.classList.remove('menu-open');}
        
        function switchTab(id){
            activeTab = id;
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');

            // Handle sidebar active state
            document.querySelectorAll('.sidebar-nav-item').forEach(div => {
                const func = div.getAttribute('onclick');
                const targetId = func.match(/'([^']+)'/)?.[1]; // Extract the target ID from the onclick attribute
                if (targetId === id) {
                    div.classList.add('active');
                    div.classList.remove('hover:bg-gray-50', 'text-gray-700');
                } else {
                    div.classList.remove('active');
                    div.classList.add('hover:bg-gray-50', 'text-gray-700');
                }
            });

            if(window.innerWidth<1024) closeSidebar(); // Always close sidebar on mobile after selection
            
            if(id==='finance') loadFin();
            else if(id==='employees') renderEmps();
            else if(id==='reports') calcReports();
            else if(id==='movements') calcMovements();
        }
        
        // Auth guard for admin tabs
        function authAdmin(t){if(isLoggedIn)switchTab(t);else {showSwal('الرجاء تسجيل الدخول أولاً', 'error'); toggleLogin();}}
        
        function updateStats(){
            let p=0,b=0;
            employees.forEach(e=>{
                const l=logs.filter(x=>x.eid===e.id).sort((m,n)=>n.ts.localeCompare(m.ts));
                if(l.length>0){
                    // If the last action was *any* 'in' (shift or return from break/perm/branch), they are Present (الحاضرون)
                    if(l[0].act==='in')p++;
                    
                    // If the last action was a temporary 'out' (break or pray), they are On Break (في استراحة)
                    if(l[0].act==='out'&&(l[0].type==='break'||l[0].type==='pray'))b++;
                }
            });
            document.getElementById('presentCount').innerText=toArabic(p);
            document.getElementById('breakCount').innerText=toArabic(b);
        }
        
        function handleAttendance(){
            const inp=document.getElementById('codeInput'),code=inp.value.trim();if(!code)return;
            const emp=employees.find(e=>e.code==code);if(!emp){showSwal('كود غير مسجل','error');inp.value='';return;}
            const l=logs.filter(x=>x.eid===emp.id).sort((m,n)=>n.ts.localeCompare(m.ts));
            const last=l[0]; let act='in',type='shift',msg=`أهلاً ${emp.name}`;
            
            if(!last||last.act==='out'){
                // This is an IN action (Check-in or Return)
                if(last&&(last.type==='break'||last.type==='pray'||last.type==='perm'||last.type==='branch')){
                    // Return from break/pray/perm/branch. Use the last type for accurate tracking.
                    type=last.type; 
                    msg='عودة للعمل';
                } else {
                    // Start of a new shift
                    type='shift'; 
                    msg=`بدء وردية ${emp.name}`;
                }
            }
            else{
                act='out';
                // Show modal for OUT action type selection
                Swal.fire({
                    title: emp.name,
                    html: `<div class="grid gap-3 mt-4"><button onclick="clickAtt('shift')" class="action-btn-gray p-4 rounded-xl font-bold w-full shadow-lg text-lg">انصراف نهائي</button><div class="flex gap-2"><button onclick="clickAtt('break')" class="action-btn-gray p-3 rounded-xl font-bold w-full">بريك</button><button onclick="clickAtt('pray')" class="action-btn-gray p-3 rounded-xl font-bold w-full">صلاة</button></div><button onclick="clickAtt('perm')" class="action-btn-gray p-3 rounded-xl font-bold w-full">إذن</button><button onclick="clickAtt('branch')" class="action-btn-gray p-3 rounded-xl font-bold w-full border border-gray-600">الفرع الآخر</button></div>`,
                    showConfirmButton: false, showCancelButton: true, cancelButtonText: 'إلغاء', cancelButtonColor: '#4B5563', background: '#000000'
                });
                // The global window.clickAtt is used to execute the logging after modal interaction
                window.clickAtt=(t)=>{type=t;msg=t==='shift'?'تم الانصراف':(t==='break'?'خرج بريك':'تم التسجيل');Swal.close();saveLog(emp,act,type,msg);};inp.value='';return;
            }
            saveLog(emp,act,type,msg);inp.value='';
        }
        function saveLog(e,a,t,m){logs.unshift({id:Date.now(),eid:e.id,name:e.name,act:a,type:t,ts:new Date().toISOString()});localStorage.setItem('sa_logs',JSON.stringify(logs));showSwal(m,'success');updateStats();}

        function calcMovements(){
            const m=document.getElementById('moveMonth').value,tb=document.getElementById('moveTableBody');tb.innerHTML='';if(!m)return;
            const ms=logs.filter(l=>l.ts.startsWith(m)).sort((a,b)=>new Date(a.ts)-new Date(b.ts));
            
            // Map to store shifts for each employee
            const employeeShifts = {};
            employees.forEach(emp => { employeeShifts[emp.id] = []; });
            
            ms.forEach(l => {
                const empId = l.eid;
                let shifts = employeeShifts[empId];
                if (!shifts) return; // Should not happen if employee exists
                
                let currentShift = shifts[shifts.length - 1] || null;
                const t = new Date(l.ts);

                if (l.act === 'in' && l.type === 'shift') {
                    // End previous shift if it wasn't closed (shouldn't happen, but safety)
                    if (currentShift && !currentShift.e) {
                         currentShift.e = currentShift.s; // Treat start as end if not closed 
                         shifts.push(currentShift);
                    }
                    // Start new shift
                    shifts.push({ date: t.toLocaleDateString('ar-EG'), name: employees.find(e => e.id === empId)?.name || 'N/A', s: t, e: null, b: 0, p: 0, pm: 0, br: 0, lastTempOut: null });
                } else if (l.act === 'out' && l.type === 'shift') {
                    if (currentShift && !currentShift.e) {
                        currentShift.e = t;
                    }
                } else if (currentShift && !currentShift.e) {
                    // Handle temporary movements within an active shift
                    if (l.act === 'out') {
                        currentShift.lastTempOut = { type: l.type, time: t };
                    } else if (l.act === 'in' && currentShift.lastTempOut && currentShift.lastTempOut.type === l.type) {
                        const duration = (t - currentShift.lastTempOut.time) / 60000;
                        if (l.type === 'break') currentShift.b += duration;
                        if (l.type === 'pray') currentShift.p += duration;
                        if (l.type === 'perm') currentShift.pm += duration;
                        if (l.type === 'branch') currentShift.br += duration;
                        currentShift.lastTempOut = null;
                    }
                }
            });

            // Flatten all shifts and render
            const allShifts = Object.values(employeeShifts).flat();
            const fmt=(n)=>n>0?(n>60?`${Math.floor(n/60)}س ${Math.floor(n%60)}د`:`${Math.floor(n)}د`):'-';
            
            allShifts.filter(s => s.e !== null).forEach(s => { // Only show complete shifts
                tb.innerHTML += `<tr class="hover:bg-gray-50 border-b">
                    <td class="p-3 text-gray-500">${toArabic(s.date)}</td>
                    <td class="p-3 font-bold">${s.name}</td>
                    <td class="p-3 text-xs dir-ltr text-right">${s.s.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} - ${s.e.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</td>
                    <td class="p-3 text-yellow-600 font-bold">${fmt(s.b)}</td>
                    <td class="p-3 text-green-600 font-bold">${fmt(s.p)}</td>
                    <td class="p-3 text-blue-600 font-bold">${fmt(s.pm)}</td>
                    <td class="p-3 text-gray-500 font-bold">${fmt(s.br)}</td>
                </tr>`;
            });
        }
        function exportMovementsExcel(){const ws=XLSX.utils.table_to_sheet(document.getElementById('moveTable'));const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Movements");XLSX.writeFile(wb,"Movements_Log.xlsx");}

        function calcReports() {
            const m=document.getElementById('reportMonth').value,tb=document.getElementById('reportBody');tb.innerHTML='';if(!m)return;
            employees.forEach(emp=>{
                let lateDeductionDays=0, overtimeHours=0, penaltyMinutes=0; 
                const el=logs.filter(l=>l.eid===emp.id&&l.ts.startsWith(m)).sort((a,b)=>new Date(a.ts)-new Date(b.ts));
                
                let currentShiftStart=null, lastBreakStart=null;
                
                const dailyRate = emp.salary / 30; // Daily salary rate
                const hourlyRate = dailyRate / 12; // Assuming 12 working hours for hourly calculation
                const minuteRate = hourlyRate / 60;

                el.forEach(log=>{
                    const logTime=new Date(log.ts);
                    
                    if(log.act==='in'&&log.type==='shift'){
                        currentShiftStart=logTime;
                        
                        // 1. Late Deduction (Arrival after shiftStart time)
                        const shiftStartTime = new Date(logTime);
                        shiftStartTime.setHours(shiftStart, 0, 0, 0); // Target shift start time
                        
                        // Only calculate late if clock-in time is *after* the target start time
                        if(logTime > shiftStartTime) {
                            const lateMinutes = (logTime - shiftStartTime) / 60000;
                            if(lateMinutes > 15){ 
                                if(lateMinutes > 120) lateDeductionDays += RULES.late120; // 1 day
                                else if(lateMinutes > 60) lateDeductionDays += RULES.late60; // 0.5 day
                                else lateDeductionDays += RULES.late15; // 0.25 day
                            }
                        }
                    }
                    
                    if(log.act==='out'&&(log.type==='break'||log.type==='pray')){
                        lastBreakStart={type:log.type,time:logTime};
                    }
                    
                    if(log.act==='in'&&lastBreakStart&&lastBreakStart.type===log.type){
                        // 2. Break/Pray Over-Limit Penalty
                        const duration=(logTime-lastBreakStart.time)/60000;
                        const limit = log.type==='break' ? RULES.breakLimit : RULES.prayLimit;
                        if(duration > limit){
                            const extraMinutes = duration - limit;
                            penaltyMinutes += extraMinutes;
                        }
                        lastBreakStart=null;
                    }
                    
                    if(log.act==='out'&&log.type==='shift'&&currentShiftStart){
                        // 3. Overtime Calculation (Assuming 12-hour shift)
                        const expectedEnd = new Date(currentShiftStart);
                        expectedEnd.setHours(expectedEnd.getHours() + 12);
                        
                        // Only calculate overtime if clock-out is *after* expected end time
                        if(logTime > expectedEnd) {
                             const overtimeMillis = logTime - expectedEnd;
                             const overtimeHrs = overtimeMillis / 3600000;
                             overtimeHours += overtimeHrs;
                        }
                        currentShiftStart=null;
                    }
                });
                
                const fineMinutesCost = penaltyMinutes * minuteRate; // Cost from exceeding break/pray limit
                const lateDaysCost = lateDeductionDays * dailyRate; // Cost from late arrivals
                const totalTimePenalty = fineMinutesCost + lateDaysCost;

                // Finance Transactions (Loan/Deduction/Revenue)
                const empFinance = finance.filter(f=>f.eid===emp.id&&f.date.startsWith(m)); 
                let totalLoanAndMoneyDeduction=0, totalRevenueCommission=0;
                
                empFinance.forEach(f=>{
                    if(f.type==='loan' || f.type==='ded_money'){
                        totalLoanAndMoneyDeduction += f.amount;
                    } else if(f.type==='ded_q'){
                        totalLoanAndMoneyDeduction += (dailyRate * 0.25);
                    } else if(f.type==='ded_h'){
                        totalLoanAndMoneyDeduction += (dailyRate * 0.5);
                    } else if(f.type==='ded_f'){
                        totalLoanAndMoneyDeduction += dailyRate;
                    } else if(f.type==='revenue'){
                        totalRevenueCommission += (f.amount * (emp.comm/100));
                    }
                });
                
                const overtimePay = overtimeHours * hourlyRate * 1.5; // 1.5x Overtime Rate
                const totalAdditional = overtimePay + totalRevenueCommission;
                const totalDeductions = totalTimePenalty + totalLoanAndMoneyDeduction;
                const netSalary = (emp.salary + totalAdditional) - totalDeductions;
                
                tb.innerHTML+=`<tr class="hover:bg-gray-50 border-b">
                    <td class="p-3 font-bold">${emp.name}</td>
                    <td class="p-3">${toArabic(emp.salary)}</td>
                    <td class="p-3 text-green-600">+${toArabic(totalAdditional.toFixed(1))}</td>
                    <td class="p-3 text-red-500">-${toArabic(totalTimePenalty.toFixed(1))}</td>
                    <td class="p-3 text-red-500">-${toArabic(totalLoanAndMoneyDeduction.toFixed(1))}</td>
                    <td class="p-3 font-bold bg-gray-50">${toArabic(netSalary.toFixed(1))}</td>
                </tr>`;
            });
        }
        
        function openEmpModal(id=null){editId=id;document.getElementById('empModal').classList.add('active');if(id){const e=employees.find(x=>x.id===id);document.getElementById('empName').value=e.name;document.getElementById('empJob').value=e.job;document.getElementById('empCode').value=e.code;document.getElementById('empSalary').value=e.salary;document.getElementById('empComm').value=e.comm;document.getElementById('empVac').value=e.vacBalance||21;}else{document.querySelectorAll('#empModal input').forEach(i=>i.value='');document.getElementById('empVac').value=21;}}
        function saveEmployee(){const n=document.getElementById('empName').value,j=document.getElementById('empJob').value,c=document.getElementById('empCode').value,s=parseFloat(document.getElementById('empSalary').value)||0,cm=parseFloat(document.getElementById('empComm').value)||0,v=parseInt(document.getElementById('empVac').value)||21;if(!n||!c)return showSwal('بيانات ناقصة','error');if(editId){const i=employees.findIndex(x=>x.id===editId);employees[i]={...employees[i],name:n,job:j,code:c,salary:s,comm:cm,vacBalance:v};}else{employees.push({id:Date.now(),name:n,job:j,code:c,salary:s,comm:cm,vacBalance:v});}localStorage.setItem('sa_emps',JSON.stringify(employees));document.getElementById('empModal').classList.remove('active');renderEmps();updateStats();showSwal('تم الحفظ','success');}
        
        function deleteEmployee(id) {
            Swal.fire({
                title: 'حذف الموظف؟', text: "لا يمكن التراجع", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#4B5563', confirmButtonText: 'حذف', cancelButtonText: 'إلغاء', background: '#000000'
            }).then((result) => {
                if (result.isConfirmed) {
                    employees = employees.filter(x => x.id !== id);
                    localStorage.setItem('sa_emps', JSON.stringify(employees)); renderEmps(); updateStats();
                    showSwal('تم الحذف', 'success');
                }
            })
        }
        function renderEmps(){document.getElementById('empTable').innerHTML=employees.map(e=>`<tr class="border-b border-gray-50 hover:bg-gray-50"><td class="p-3 text-gray-400">#${toArabic(e.code)}</td><td class="p-3 font-bold">${e.name}</td><td class="p-3 text-xs">${e.job}</td><td class="p-3 font-bold">${toArabic(e.salary)}</td><td class="p-3 text-blue-600 font-bold">${toArabic(e.vacBalance||0)}</td><td class="p-3 text-yellow-600 font-bold">${toArabic(e.comm||0)}%</td><td class="p-3 text-center flex justify-center gap-2"><button onclick="openEmpModal(${e.id})" class="text-blue-500 mx-1"><i class="fas fa-edit"></i></button><button onclick="deleteEmployee(${e.id})" class="text-red-500 mx-1"><i class="fas fa-trash"></i></button></td></tr>`).join('');}
        
        function loadFin(){const s=document.getElementById('finEmpSelect');s.innerHTML='<option value="">اختر موظف</option>';employees.forEach(e=>s.innerHTML+=`<option value="${e.id}">${e.name}</option>`);toggleAmount();}
        function toggleAmount(){const t=document.getElementById('finType').value;document.getElementById('finAmount').style.display=(t==='loan'||t==='ded_money'||t==='revenue')?'block':'none';}
        function showEmpFinance(){
            const eid=parseInt(document.getElementById('finEmpSelect').value);
            if(!eid) {
                document.getElementById('finName').innerText='اختر موظف';
                document.getElementById('finTotal').innerText='0.00';
                document.getElementById('finVacBal').innerText='0';
                document.getElementById('finDailyRate').innerText='0.00';
                document.getElementById('finTable').innerHTML='<tr><td colspan="4" class="p-8 text-center text-gray-400">لا توجد بيانات</td></tr>';
                return;
            }
            
            const emp=employees.find(e=>e.id===eid);
            if (!emp) return;

            const fs=finance.filter(f=>f.eid===eid).sort((a,b)=>new Date(b.date)-new Date(a.date));
            const dailyRate = emp.salary / 30;
            
            document.getElementById('finTable').innerHTML=fs.map(f=>{
                let t='', v=f.amount.toFixed(2), color='text-red-500';
                if(f.type==='loan') { t='سلفة نقدية'; color='text-red-500'; }
                else if(f.type==='ded_money') { t='خصم مالي'; color='text-red-500'; }
                else if(f.type==='ded_q') { t='خصم ربع يوم'; v=(dailyRate*0.25).toFixed(2); color='text-red-500'; } 
                else if(f.type==='ded_h') { t='خصم نص يوم'; v=(dailyRate*0.5).toFixed(2); color='text-red-500'; } 
                else if(f.type==='ded_f') { t='غياب يوم كامل'; v=dailyRate.toFixed(2); color='text-red-500'; } 
                else if(f.type==='revenue') { t='إيراد شغل'; color='text-green-500'; } 
                else if(f.type==='vacation') { t='إجازة رصيد'; v='-'; color='text-blue-500'; }
                
                return `<tr class="border-b">
                    <td class="p-2 text-gray-500">${toArabic(new Date(f.date).toLocaleDateString('ar-EG'))}</td>
                    <td class="p-2 font-bold">${t}</td>
                    <td class="p-2 font-bold ${color}">${f.type!=='vacation'?toArabic(v):'-'}</td>
                    <td class="p-2 text-center"><i onclick="delFin(${f.id})" class="fas fa-times text-gray-300 cursor-pointer hover:text-red-500"></i></td>
                </tr>`;
            }).join('');
            
            document.getElementById('finName').innerText=emp.name;
            document.getElementById('finDailyRate').innerText = toArabic(dailyRate.toFixed(2));

            // Sum up only financial deductions (loan/ded_money) - the deduction days are calculated in reports
            const totalLoan = fs.filter(x => x.type === 'loan' || x.type === 'ded_money').reduce((a, b) => a + b.amount, 0);
            document.getElementById('finTotal').innerText=toArabic(totalLoan.toFixed(2)); 
            document.getElementById('finVacBal').innerText=toArabic(emp.vacBalance || 0);
        }
        function addTransaction(){
            const eid=parseInt(document.getElementById('finEmpSelect').value), t=document.getElementById('finType').value; 
            let amt=0; 
            
            if(!eid) return showSwal('الرجاء اختيار موظف', 'error');

            if(t==='loan'||t==='ded_money'||t==='revenue'){
                amt=parseFloat(document.getElementById('finAmount').value);
                if(!amt || amt <= 0) return showSwal('الرجاء إدخال قيمة صحيحة', 'error');
            } 
            
            if(t==='vacation'){
                const i=employees.findIndex(e=>e.id===eid);
                if(employees[i].vacBalance > 0){
                    employees[i].vacBalance -= 1;
                    localStorage.setItem('sa_emps',JSON.stringify(employees));
                    finance.push({id:Date.now(),eid,type:t,amount:0,date:new Date().toLocaleDateString('en-CA')}); // Save vacation log
                }else{
                    return showSwal('رصيد الإجازات لا يكفي','error');
                }
            } else {
                finance.push({id:Date.now(),eid,type:t,amount:amt,date:new Date().toLocaleDateString('en-CA')});
            }
            
            localStorage.setItem('sa_fin',JSON.stringify(finance));
            showSwal('تم','success');
            showEmpFinance();
            document.getElementById('finAmount').value = ''; // Clear amount field
        }
        
        function delFin(id){
            Swal.fire({
                title: 'حذف العملية؟', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#4B5563', confirmButtonText: 'نعم', cancelButtonText: 'إلغاء', background: '#000000'
            }).then((result) => {
                if (result.isConfirmed) {
                    const transactionToDelete = finance.find(x => x.id === id);
                    if (transactionToDelete && transactionToDelete.type === 'vacation') {
                        // Restore vacation balance if deleting a vacation log
                        const empIndex = employees.findIndex(e => e.id === transactionToDelete.eid);
                        if (empIndex !== -1) {
                            employees[empIndex].vacBalance += 1;
                            localStorage.setItem('sa_emps', JSON.stringify(employees));
                        }
                    }

                    finance = finance.filter(x => x.id !== id);
                    localStorage.setItem('sa_fin', JSON.stringify(finance)); 
                    showEmpFinance();
                    showSwal('تم الحذف', 'success');
                }
            })
        }
        
        function saveMsg(){
            const m = document.getElementById('adminMsgIn').value;
            const min = parseInt(document.getElementById('msgDur').value) || 60; 
            const expiry = Date.now() + (min * 60 * 1000);
            
            localStorage.setItem('sa_msg', m);
            localStorage.setItem('sa_msg_exp', expiry);
            
            document.getElementById('adminMsgText').innerText = m;
            document.getElementById('adminMsgBar').classList.remove('hidden');
            showSwal('تم النشر', 'success');
        }

        function savePass(){const n=document.getElementById('newPass').value;if(n.length>=4){localStorage.setItem('sa_pin',n);adminPIN=n;showSwal('تم التحديث','success');}}
        function saveShift(){const v=parseInt(document.getElementById('shiftStartInput').value);if(v>=0 && v<24){shiftStart=v;localStorage.setItem('sa_shift',v);showSwal('تم الحفظ','success');} else {showSwal('يجب أن تكون القيمة بين 0 و 23', 'error');}}
        
        function resetSys(){
            Swal.fire({
                title: 'حذف جميع البيانات؟', text: "لا يمكن التراجع", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#4B5563', confirmButtonText: 'نعم، فرمتة', cancelButtonText: 'إلغاء', background: '#000000'
            }).then((result) => {
                if (result.isConfirmed) { localStorage.clear(); location.reload(); }
            })
        }
        
        function changePassModal() {
            Swal.fire({
                title: 'تغيير كلمة المرور',
                html: `<input type="password" id="oldPass" class="swal-lux-input" placeholder="القديمة"><input type="password" id="newPassSwal" class="swal-lux-input" placeholder="الجديدة">`,
                showCancelButton: true, confirmButtonText: 'تحديث', cancelButtonText: 'إلغاء', background: '#000000', confirmButtonColor: '#1F2937', cancelButtonColor: '#4B5563',
                preConfirm: () => [document.getElementById('oldPass').value, document.getElementById('newPassSwal').value]
            }).then((res) => {
                if (res.value) {
                    if (res.value[0] === adminPIN && res.value[1].length >= 4) {
                        adminPIN = res.value[1]; localStorage.setItem('sa_pin', adminPIN); showSwal('تم التحديث', 'success');
                    } else { showSwal('بيانات خاطئة', 'error'); }
                }
            });
        }
        
        function exportExcel(){const ws=XLSX.utils.table_to_sheet(document.getElementById('salaryTable'));const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Sheet1");XLSX.writeFile(wb,"Report.xlsx");}
        
        function backupData() { 
            const a=document.createElement('a'); 
            a.href=URL.createObjectURL(new Blob([JSON.stringify({e:employees,l:logs,f:finance,p:adminPIN,s:shiftStart})],{type:'application/json'})); 
            a.download='SAMY_AHMED_HR_Backup.json'; 
            a.click(); 
        }

        function restoreData(i) { 
            const r = new FileReader();
            r.onload = e => {
                try {
                    const d = JSON.parse(e.target.result);
                    // Basic validation
                    if (!d.e || !d.l || !d.f || !d.p) {
                        showSwal('ملف النسخ الاحتياطي تالف أو غير صالح', 'error');
                        return;
                    }

                    // Update global variables
                    employees = d.e;
                    logs = d.l;
                    finance = d.f;
                    adminPIN = d.p; 
                    shiftStart = d.s || 13; // Use backup value or default

                    // Save updated data to LocalStorage
                    localStorage.setItem('sa_emps', JSON.stringify(employees));
                    localStorage.setItem('sa_logs', JSON.stringify(logs));
                    localStorage.setItem('sa_fin', JSON.stringify(finance));
                    localStorage.setItem('sa_pin', adminPIN);
                    localStorage.setItem('sa_shift', shiftStart);

                    showSwal('تم استعادة البيانات بنجاح. سيتم تحديث الصفحة.', 'success');
                    setTimeout(() => location.reload(), 1500);

                } catch (error) {
                    console.error("Restore Error:", error);
                    showSwal('خطأ في معالجة ملف النسخ الاحتياطي. تأكد أنه ملف JSON صحيح.', 'error');
                }
            };
            // Ensure a file was selected
            if (i.files.length > 0) {
                r.readAsText(i.files[0]);
            } else {
                showSwal('الرجاء تحديد ملف النسخ الاحتياطي', 'error');
            }
        }
    </script>
</body>
</html>

